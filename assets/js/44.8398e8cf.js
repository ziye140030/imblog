(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{391:function(e,t,_){"use strict";_.r(t);var v=_(0),s=Object(v.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"快速部署k8s集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#快速部署k8s集群"}},[e._v("#")]),e._v(" 快速部署k8s集群")]),e._v(" "),t("p",[e._v("kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。")]),e._v(" "),t("p",[e._v("这个工具能通过两条指令完成一个kubernetes集群的部署：")]),e._v(" "),t("p",[e._v("# 创建一个 Master 节点")]),e._v(" "),t("p",[e._v("$ kubeadm init")]),e._v(" "),t("p",[e._v("# 将一个 Node 节点加入到当前集群中")]),e._v(" "),t("p",[e._v("$ kubeadm join <Master节点的IP和端口 >")]),e._v(" "),t("h2",{attrs:{id:"_1-安装要求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装要求"}},[e._v("#")]),e._v(" 1. 安装要求")]),e._v(" "),t("p",[e._v("在开始之前，部署Kubernetes集群机器需要满足以下几个条件：")]),e._v(" "),t("ul",[t("li",[e._v("一台或多台机器，操作系统 CentOS7.x-86_x64")]),e._v(" "),t("li",[e._v("硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多")]),e._v(" "),t("li",[e._v("可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点")]),e._v(" "),t("li",[e._v("禁止swap分区")])]),e._v(" "),t("h2",{attrs:{id:"_2-准备环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-准备环境"}},[e._v("#")]),e._v(" 2. 准备环境")]),e._v(" "),t("table",[t("thead",[t("tr",[t("th",[e._v("角色")]),e._v(" "),t("th",[e._v("IP")])])]),e._v(" "),t("tbody",[t("tr",[t("td",[e._v("master")]),e._v(" "),t("td",[e._v("192.168.1.11")])]),e._v(" "),t("tr",[t("td",[e._v("node1")]),e._v(" "),t("td",[e._v("192.168.1.12")])]),e._v(" "),t("tr",[t("td",[e._v("node2")]),e._v(" "),t("td",[e._v("192.168.1.13")])])])]),e._v(" "),t("p",[e._v("# 关闭防火墙")]),e._v(" "),t("p",[e._v("systemctl stop firewalld")]),e._v(" "),t("p",[e._v("systemctl disable firewalld")]),e._v(" "),t("p",[e._v("# 关闭selinux")]),e._v(" "),t("p",[e._v("sed -i 's/enforcing/disabled/' /etc/selinux/config  # 永久")]),e._v(" "),t("p",[e._v("setenforce 0  # 临时")]),e._v(" "),t("p",[e._v("# 关闭swap")]),e._v(" "),t("p",[e._v("swapoff -a  # 临时")]),e._v(" "),t("p",[e._v("sed -ri 's/."),t("em",[e._v("swap.")]),e._v("/#&/' /etc/fstab   # 永久")]),e._v(" "),t("p",[e._v("# 根据规划设置主机名")]),e._v(" "),t("p",[e._v("hostnamectl set-hostname "),t("hostname")],1),e._v(" "),t("p",[e._v("# 在master添加hosts")]),e._v(" "),t("p",[e._v("cat >> /etc/hosts << EOF")]),e._v(" "),t("p",[e._v("192.168.44.146 k8smaster")]),e._v(" "),t("p",[e._v("192.168.44.145 k8snode1")]),e._v(" "),t("p",[e._v("192.168.44.144 k8snode2")]),e._v(" "),t("p",[e._v("EOF")]),e._v(" "),t("p",[e._v("# 将桥接的IPv4流量传递到iptables的链")]),e._v(" "),t("p",[e._v("cat > /etc/sysctl.d/k8s.conf << EOF")]),e._v(" "),t("p",[e._v("net.bridge.bridge-nf-call-ip6tables = 1")]),e._v(" "),t("p",[e._v("net.bridge.bridge-nf-call-iptables = 1")]),e._v(" "),t("p",[e._v("EOF")]),e._v(" "),t("p",[e._v("sysctl --system  # 生效")]),e._v(" "),t("p",[e._v("# 时间同步")]),e._v(" "),t("p",[e._v("yum install ntpdate -y")]),e._v(" "),t("p",[e._v("ntpdate time.windows.com")]),e._v(" "),t("h2",{attrs:{id:"_3-所有节点安装docker-kubeadm-kubelet"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-所有节点安装docker-kubeadm-kubelet"}},[e._v("#")]),e._v(" 3. 所有节点安装Docker/kubeadm/kubelet")]),e._v(" "),t("p",[e._v("Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。")]),e._v(" "),t("h3",{attrs:{id:"_3-1-安装docker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-安装docker"}},[e._v("#")]),e._v(" 3.1 安装Docker")]),e._v(" "),t("p",[e._v("$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo")]),e._v(" "),t("p",[e._v("$ yum -y install docker-ce-18.06.1.ce-3.el7")]),e._v(" "),t("p",[e._v("$ systemctl enable docker && systemctl start docker")]),e._v(" "),t("p",[e._v("$ docker --version")]),e._v(" "),t("p",[e._v("Docker version 18.06.1-ce, build e68fc7a")]),e._v(" "),t("p",[e._v("$ cat > /etc/docker/daemon.json << EOF")]),e._v(" "),t("p",[e._v("{")]),e._v(" "),t("p",[e._v('"registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]')]),e._v(" "),t("p",[e._v("}")]),e._v(" "),t("p",[e._v("EOF")]),e._v(" "),t("h3",{attrs:{id:"_3-2-添加阿里云yum软件源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-添加阿里云yum软件源"}},[e._v("#")]),e._v(" 3.2 添加阿里云YUM软件源")]),e._v(" "),t("p",[e._v("$ cat > /etc/yum.repos.d/kubernetes.repo << EOF")]),e._v(" "),t("p",[e._v("[kubernetes]")]),e._v(" "),t("p",[e._v("name=Kubernetes")]),e._v(" "),t("p",[e._v("baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64")]),e._v(" "),t("p",[e._v("enabled=1")]),e._v(" "),t("p",[e._v("gpgcheck=0")]),e._v(" "),t("p",[e._v("repo_gpgcheck=0")]),e._v(" "),t("p",[e._v("gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg")]),e._v(" "),t("p",[e._v("EOF")]),e._v(" "),t("h3",{attrs:{id:"_3-3-安装kubeadm-kubelet和kubectl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-安装kubeadm-kubelet和kubectl"}},[e._v("#")]),e._v(" 3.3 安装kubeadm，kubelet和kubectl")]),e._v(" "),t("p",[e._v("由于版本更新频繁，这里指定版本号部署：")]),e._v(" "),t("p",[e._v("$ yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0")]),e._v(" "),t("p",[e._v("$ systemctl enable kubelet")]),e._v(" "),t("h2",{attrs:{id:"_4-部署kubernetes-master"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-部署kubernetes-master"}},[e._v("#")]),e._v(" 4. 部署Kubernetes Master")]),e._v(" "),t("p",[e._v("在192.168.1.11（Master）执行。")]),e._v(" "),t("p",[e._v("$ kubeadm init \\")]),e._v(" "),t("p",[e._v("--apiserver-advertise-address=192.168.31.61 \\")]),e._v(" "),t("p",[e._v("--image-repository registry.aliyuncs.com/google_containers \\")]),e._v(" "),t("p",[e._v("--kubernetes-version v1.18.0 \\")]),e._v(" "),t("p",[e._v("--service-cidr=10.96.0.0/12 \\")]),e._v(" "),t("p",[e._v("--pod-network-cidr=10.244.0.0/16")]),e._v(" "),t("p",[e._v("由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址。")]),e._v(" "),t("p",[e._v("使用kubectl工具：")]),e._v(" "),t("p",[e._v("mkdir -p $HOME/.kube")]),e._v(" "),t("p",[e._v("sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config")]),e._v(" "),t("p",[e._v("sudo chown $(id -u)😒(id -g) $HOME/.kube/config")]),e._v(" "),t("p",[e._v("$ kubectl get nodes")]),e._v(" "),t("h2",{attrs:{id:"_5-加入kubernetes-node"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-加入kubernetes-node"}},[e._v("#")]),e._v(" 5. 加入Kubernetes Node")]),e._v(" "),t("p",[e._v("在192.168.1.12/13（Node）执行。")]),e._v(" "),t("p",[e._v("向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：")]),e._v(" "),t("p",[e._v("$ kubeadm join 192.168.1.11:6443 --token esce21.q6hetwm8si29qxwn \\")]),e._v(" "),t("p",[e._v("--discovery-token-ca-cert-hash sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5")]),e._v(" "),t("p",[e._v("默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：")]),e._v(" "),t("p",[e._v("kubeadm token create --print-join-command")]),e._v(" "),t("h2",{attrs:{id:"_6-部署cni网络插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-部署cni网络插件"}},[e._v("#")]),e._v(" 6. 部署CNI网络插件")]),e._v(" "),t("p",[e._v("wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml")]),e._v(" "),t("p",[e._v("默认镜像地址无法访问，sed命令修改为docker hub镜像仓库。")]),e._v(" "),t("p",[e._v("kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml")]),e._v(" "),t("p",[e._v("kubectl get pods -n kube-system")]),e._v(" "),t("p",[e._v("NAME              READY  STATUS   RESTARTS  AGE")]),e._v(" "),t("p",[e._v("kube-flannel-ds-amd64-2pc95  1/1   Running  0      72s")]),e._v(" "),t("h2",{attrs:{id:"_7-测试kubernetes集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-测试kubernetes集群"}},[e._v("#")]),e._v(" 7. 测试kubernetes集群")]),e._v(" "),t("p",[e._v("在Kubernetes集群中创建一个pod，验证是否正常运行：")]),e._v(" "),t("p",[e._v("$ kubectl create deployment nginx --image=nginx")]),e._v(" "),t("p",[e._v("$ kubectl expose deployment nginx --port=80 --type=NodePort")]),e._v(" "),t("p",[e._v("$ kubectl get pod,svc")]),e._v(" "),t("p",[e._v("访问地址：http://NodeIP:Port")])])}),[],!1,null,null,null);t.default=s.exports}}]);